<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Code Trails — Post</title>
    <meta name="description" content="Rendered blog post" />
    <style>
      :root { --bg:#ffffff; --fg:#030202; --muted:#6b7280; --divider:#e5e7eb; --maxw: 900px; }
      * { box-sizing: border-box; }
      body { margin:0; font-family: ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial; color:var(--fg); background:var(--bg); line-height:1.6; }
      .wrap { max-width: var(--maxw); margin: 0 auto; padding: 28px 20px 64px; }
      header h1 { font-size: clamp(28px, 4.5vw, 42px); margin: 6px 0 18px; letter-spacing: -0.01em; }
      .meta { color: var(--muted); font-size: 14px; margin-bottom: 18px; }
      article img { max-width: 100%; height: auto; border-radius: 4px; }
      article pre { background:#0f172a; color:#e2e8f0; padding:12px 14px; overflow:auto; border-radius:6px; }
      article code { background:#f3f4f6; padding: 0 4px; border-radius: 3px; }
      article h2 { font-size: 1.6rem; margin-top: 1.8rem; }
      article h3 { font-size: 1.3rem; margin-top: 1.4rem; }
      article h4 { font-size: 1.1rem; margin-top: 1.1rem; }
      article p { margin: 0.7rem 0; }
      article ul { padding-left: 1.2rem; }
      .back { display:inline-block; margin-bottom: 12px; color:#2563eb; text-decoration:none; }
      .back:hover { text-decoration: underline; }
      hr { border: 0; border-top: 1px solid var(--divider); margin: 18px 0; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <a class="back" href="./index.html">← Back</a>
      <header>
        <h1 id="post-title">Loading…</h1>
        <div id="post-meta" class="meta"></div>
      </header>
      <article id="post"></article>
    </div>

    <script>
      function qs(name) {
        const p = new URLSearchParams(location.search);
        return p.get(name) || '';
      }

      function parseFrontMatter(src) {
        if (!src.startsWith('---')) return { meta:{}, body: src };
        const end = src.indexOf('\n---');
        if (end === -1) return { meta:{}, body: src };
        const fmRaw = src.slice(3, end).trim();
        const body = src.slice(end + 4).replace(/^\s*\n/, '');
        const meta = {};
        fmRaw.split(/\r?\n/).forEach(line => {
          const m = line.match(/^([A-Za-z0-9_-]+):\s*(.*)$/);
          if (m) {
            let val = m[2].trim();
            if ((val.startsWith('"') && val.endsWith('"')) || (val.startsWith("'") && val.endsWith("'"))) {
              val = val.slice(1, -1);
            }
            meta[m[1]] = val;
          }
        });
        return { meta, body };
      }

      function resolveUrl(url, baseDir) {
        if (/^(https?:)?\/\//i.test(url) || url.startsWith('/') ) return url;
        return baseDir + url.replace(/^\.\//, '');
      }

      function renderMarkdown(md, baseDir) {
        // Escape HTML to avoid injection, then allow specific tags later via replacements
        md = md.replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch]));

        // Normalize Windows line endings
        md = md.replace(/\r\n?/g, '\n');

        // Code spans
        md = md.replace(/`([^`]+)`/g, '<code>$1</code>');

        // Images
        md = md.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (m, alt, src) => {
          return `<img alt="${alt}" src="${resolveUrl(src, baseDir)}">`;
        });

        // Links (support nested, use [\s\S])
        md = md.replace(/\[([\s\S]*?)\]\(([^)]+)\)/g, (m, text, href) => {
          return `<a href="${resolveUrl(href, baseDir)}" target="_blank" rel="noopener">${text}</a>`;
        });

        // Bold/italic (order matters to avoid collisions)
        md = md.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
        md = md.replace(/\*([^*]+)\*/g, '<em>$1</em>');

        const lines = md.split('\n');
        const out = [];
        let inList = false;
        let para = [];

        const flushPara = () => {
          if (para.length) {
            out.push('<p>' + para.join(' ').trim() + '</p>');
            para = [];
          }
        };

        for (let i=0; i<lines.length; i++) {
          const line = lines[i];
          if (!line.trim()) { // blank line
            if (inList) { out.push('</ul>'); inList = false; }
            flushPara();
            continue;
          }

          if (/^---\s*$/.test(line)) { if (inList) { out.push('</ul>'); inList=false; } flushPara(); out.push('<hr>'); continue; }
          if (/^####\s+/.test(line)) { if (inList) { out.push('</ul>'); inList=false; } flushPara(); out.push('<h4>' + line.replace(/^####\s+/, '') + '</h4>'); continue; }
          if (/^###\s+/.test(line))  { if (inList) { out.push('</ul>'); inList=false; } flushPara(); out.push('<h3>' + line.replace(/^###\s+/, '') + '</h3>'); continue; }
          if (/^##\s+/.test(line))   { if (inList) { out.push('</ul>'); inList=false; } flushPara(); out.push('<h2>' + line.replace(/^##\s+/, '') + '</h2>'); continue; }

          const li = line.match(/^\s*-\s+(.*)$/);
          if (li) {
            flushPara();
            if (!inList) { out.push('<ul>'); inList = true; }
            out.push('<li>' + li[1] + '</li>');
            continue;
          }

          // default: paragraph text (join consecutive lines)
          para.push(line.trim());
        }

        if (inList) out.push('</ul>');
        flushPara();
        return out.join('\n');
      }

      async function main() {
        const src = qs('src');
        if (!src) {
          document.getElementById('post-title').textContent = 'No source specified';
          return;
        }
        if (location.protocol === 'file:') {
          document.getElementById('post-title').textContent = 'Serve this site via HTTP';
          document.getElementById('post').innerHTML = '<p>Markdown fetching is blocked from file:// URLs by browsers. Please run a local web server (e.g., <code>python3 -m http.server</code>) and open via <code>http://localhost:8000/code-trails/post.html?src=Sept-1-25-understanding-cosine-simularity.md</code>.</p>';
          return;
        }
        const baseDir = src.includes('/') ? src.slice(0, src.lastIndexOf('/')+1) : '';
        const url = new URL(src, location.href).toString();
        let text = '';
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error('HTTP ' + res.status + ' ' + res.statusText);
          text = await res.text();
        } catch (e) {
          document.getElementById('post-title').textContent = 'Error loading post';
          document.getElementById('post').innerHTML = '<p>Failed to fetch <code>' + url + '</code>.<br>' +
            'If you are running locally, start a web server (e.g., <code>python3 -m http.server</code>) and open this page via <code>http://</code> not <code>file://</code>.</p>' +
            '<p>Details: ' + String(e) + '</p>';
          return;
        }
        const { meta, body } = parseFrontMatter(text);
        const title = meta.title || src;
        document.getElementById('post-title').textContent = title;
        document.title = 'Code Trails — ' + title;
        document.getElementById('post').innerHTML = renderMarkdown(body, baseDir);
      }

      main().catch(err => {
        document.getElementById('post-title').textContent = 'Error loading post';
        document.getElementById('post').textContent = String(err);
      });
    </script>
  </body>
  </html>
